<!DOCTYPE html>
<html lang="zh-CN">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>å›¾ç‰‡é¢„è§ˆ</title>
    <style>
      * {
        margin: 0;
        padding: 0;
        box-sizing: border-box;
      }

      :root {
        --bg-color: #ffffff;
        --text-color: #333333;
        --titlebar-bg: #f5f5f5;
        --titlebar-border: #e0e0e0;
        --button-hover: rgba(0, 0, 0, 0.1);
        --button-active: rgba(0, 0, 0, 0.2);
        --close-hover: #ff4d4f;
        --close-active: #cf1322;
        --nav-bg: rgba(0, 0, 0, 0.6);
        --info-bg: rgba(0, 0, 0, 0.7);
      }

      [data-theme="dark"] {
        --bg-color: #1a1a1a;
        --text-color: #ffffff;
        --titlebar-bg: #2c2c2c;
        --titlebar-border: #333333;
        --button-hover: rgba(255, 255, 255, 0.1);
        --button-active: rgba(255, 255, 255, 0.2);
        --close-hover: #ff4d4f;
        --close-active: #cf1322;
        --nav-bg: rgba(0, 0, 0, 0.6);
        --info-bg: rgba(0, 0, 0, 0.7);
      }

      body {
        font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto,
          sans-serif;
        background: var(--bg-color);
        color: var(--text-color);
        overflow: hidden;
        user-select: none;
        /* ç¡®ä¿ä¸ä¼šé˜»æ­¢é”®ç›˜äº‹ä»¶ */
        outline: none;
      }

      /* è‡ªå®šä¹‰æ ‡é¢˜æ  */
      .titlebar {
        position: fixed;
        top: 0;
        left: 0;
        right: 0;
        height: 40px;
        background: var(--titlebar-bg);
        display: flex;
        align-items: center;
        justify-content: center;
        padding: 0 16px;
        z-index: 1000;
        -webkit-app-region: drag;
        border-bottom: 1px solid var(--titlebar-border);
      }

      .titlebar-title {
        font-size: 14px;
        font-weight: 500;
        color: var(--text-color);
      }

      /* åº•éƒ¨å·¥å…·æ  */
      .bottom-toolbar {
        position: fixed;
        bottom: 0;
        left: 0;
        right: 0;
        height: 60px;
        background: var(--titlebar-bg);
        display: flex;
        align-items: center;
        justify-content: center;
        padding: 0 16px;
        z-index: 1000;
        border-top: 1px solid var(--titlebar-border);
        backdrop-filter: blur(10px);
        box-shadow: 0 -2px 10px rgba(0, 0, 0, 0.1);
      }

      .toolbar-buttons {
        display: flex;
        align-items: center;
        gap: 8px;
        -webkit-app-region: no-drag;
      }

      .toolbar-button {
        width: 40px;
        height: 40px;
        border: none;
        background: transparent;
        color: var(--text-color);
        border-radius: 8px;
        cursor: pointer;
        display: flex;
        align-items: center;
        justify-content: center;
        font-size: 16px;
        transition: all 0.2s ease;
        -webkit-app-region: no-drag;
        margin: 0 2px;
        position: relative;
      }

      .toolbar-button:hover {
        background: var(--button-hover);
        transform: scale(1.1);
      }

      .toolbar-button:active {
        background: var(--button-active);
        transform: scale(0.95);
      }

      /* ç¼©æ”¾æŒ‰é’®ç‰¹æ®Šæ ·å¼ */
      .toolbar-button[title="æ”¾å¤§"],
      .toolbar-button[title="ç¼©å°"] {
        background: rgba(0, 0, 0, 0.1);
        border: 1px solid rgba(0, 0, 0, 0.2);
      }

      .toolbar-button[title="æ”¾å¤§"]:hover,
      .toolbar-button[title="ç¼©å°"]:hover {
        background: rgba(0, 0, 0, 0.2);
        border-color: rgba(0, 0, 0, 0.3);
      }

      [data-theme="dark"] .toolbar-button[title="æ”¾å¤§"],
      [data-theme="dark"] .toolbar-button[title="ç¼©å°"] {
        background: rgba(255, 255, 255, 0.1);
        border: 1px solid rgba(255, 255, 255, 0.2);
      }

      [data-theme="dark"] .toolbar-button[title="æ”¾å¤§"]:hover,
      [data-theme="dark"] .toolbar-button[title="ç¼©å°"]:hover {
        background: rgba(255, 255, 255, 0.2);
        border-color: rgba(255, 255, 255, 0.3);
      }

      .toolbar-button.danger:hover {
        background: var(--close-hover);
      }

      .toolbar-button.danger:active {
        background: var(--close-active);
      }

      .titlebar-left {
        display: flex;
        align-items: center;
        gap: 8px;
      }

      .titlebar-center {
        display: flex;
        align-items: center;
        gap: 8px;
        -webkit-app-region: no-drag;
      }

      .titlebar-button {
        width: 32px;
        height: 32px;
        border: none;
        background: transparent;
        color: var(--text-color);
        border-radius: 6px;
        cursor: pointer;
        display: flex;
        align-items: center;
        justify-content: center;
        font-size: 16px;
        transition: all 0.2s ease;
        -webkit-app-region: no-drag;
        /* ä¼˜åŒ–æŒ‰é’®æ ·å¼ */
        margin: 0 2px;
        position: relative;
      }

      .titlebar-button:hover {
        background: var(--button-hover);
        transform: scale(1.1);
      }

      .titlebar-button:active {
        background: var(--button-active);
        transform: scale(0.95);
      }

      /* ç¼©æ”¾æŒ‰é’®ç‰¹æ®Šæ ·å¼ */
      .titlebar-button[title="æ”¾å¤§"],
      .titlebar-button[title="ç¼©å°"] {
        background: rgba(0, 0, 0, 0.1);
        border: 1px solid rgba(0, 0, 0, 0.2);
      }

      .titlebar-button[title="æ”¾å¤§"]:hover,
      .titlebar-button[title="ç¼©å°"]:hover {
        background: rgba(0, 0, 0, 0.2);
        border-color: rgba(0, 0, 0, 0.3);
      }

      [data-theme="dark"] .titlebar-button[title="æ”¾å¤§"],
      [data-theme="dark"] .titlebar-button[title="ç¼©å°"] {
        background: rgba(255, 255, 255, 0.1);
        border: 1px solid rgba(255, 255, 255, 0.2);
      }

      [data-theme="dark"] .titlebar-button[title="æ”¾å¤§"]:hover,
      [data-theme="dark"] .titlebar-button[title="ç¼©å°"]:hover {
        background: rgba(255, 255, 255, 0.2);
        border-color: rgba(255, 255, 255, 0.3);
      }

      .titlebar-button.danger:hover {
        background: var(--close-hover);
      }

      .titlebar-button.danger:active {
        background: var(--close-active);
      }

      .titlebar-right {
        display: flex;
        align-items: center;
        gap: 4px;
        -webkit-app-region: no-drag;
      }

      .window-controls {
        display: flex;
        align-items: center;
      }

      .window-control {
        width: 46px;
        height: 32px;
        border: none;
        background: transparent;
        color: var(--text-color);
        cursor: pointer;
        display: flex;
        align-items: center;
        justify-content: center;
        font-size: 14px;
        transition: all 0.2s ease;
        -webkit-app-region: no-drag;
      }

      .window-control:hover {
        background: var(--button-hover);
      }

      .window-control.close:hover {
        background: var(--close-hover);
      }

      .window-control.close:active {
        background: var(--close-active);
      }

      /* ä¸»å®¹å™¨ */
      .container {
        position: fixed;
        top: 40px;
        left: 0;
        right: 0;
        bottom: 60px;
        display: flex;
        align-items: center;
        justify-content: center;
        background: var(--bg-color);
        overflow: hidden;
        /* ç¡®ä¿ä¸ä¼šé˜»æ­¢æ»šè½®äº‹ä»¶ */
        pointer-events: auto;
      }

      /* å›¾ç‰‡å®¹å™¨ */
      .image-container {
        position: relative;
        width: 100%;
        height: 100%;
        display: flex;
        align-items: center;
        justify-content: center;
        transition: transform 0.3s ease;
        /* ç¡®ä¿ä¸ä¼šé˜»æ­¢æ»šè½®äº‹ä»¶ */
        pointer-events: auto;
        /* æ‹–åŠ¨ç›¸å…³æ ·å¼ */
        cursor: grab;
        user-select: none;
      }

      .image-container:active {
        cursor: grabbing;
      }

      .image-container img {
        max-width: calc(100% - 40px);
        max-height: calc(100% - 40px);
        object-fit: contain;

        transition: all 0.3s ease;
        /* ç¡®ä¿å›¾ç‰‡ä¿æŒåŸå§‹æ¯”ä¾‹ï¼Œä¸é“ºæ»¡çª—å£ */
        width: auto;
        height: auto;
        /* ç¡®ä¿ä¸ä¼šé˜»æ­¢æ»šè½®äº‹ä»¶ */
        pointer-events: auto;
      }

      /* å¯¼èˆªæŒ‰é’® */
      .nav-button {
        position: absolute;
        top: 50%;
        transform: translateY(-50%);
        width: 48px;
        height: 48px;
        background: var(--nav-bg);
        border: none;
        color: #fff;
        border-radius: 50%;
        cursor: pointer;
        display: flex;
        align-items: center;
        justify-content: center;
        font-size: 20px;
        transition: all 0.3s ease;
        z-index: 100;
        /* é»˜è®¤éšè— */
        opacity: 0;
        visibility: hidden;
      }

      .nav-button:hover {
        background: rgba(0, 0, 0, 0.8);
        transform: translateY(-50%) scale(1.1);
      }

      .nav-button.prev {
        left: 20px;
      }

      .nav-button.next {
        right: 10px;
      }

      .nav-button:disabled {
        opacity: 0;
        cursor: not-allowed;
        transform: translateY(-50%) scale(1);
      }

      /* å®¹å™¨ç§»å…¥æ—¶æ˜¾ç¤ºå¯¼èˆªæŒ‰é’® */
      .container:hover .nav-button:not(:disabled) {
        opacity: 1;
        visibility: visible;
      }

      /* æ‹–åŠ¨æç¤º */
      .drag-hint {
        position: absolute;
        bottom: 60px;
        left: 50%;
        transform: translateX(-50%);
        background: var(--info-bg);
        color: #fff;
        padding: 8px 16px;
        border-radius: 20px;
        font-size: 12px;
        backdrop-filter: blur(10px);
        z-index: 100;
        border: 1px solid rgba(255, 255, 255, 0.2);
        box-shadow: 0 2px 8px rgba(0, 0, 0, 0.3);
        opacity: 0;
        transition: opacity 0.3s ease;
      }

      .drag-hint.show {
        opacity: 1;
      }

      /* åŠ è½½åŠ¨ç”» */
      .loading {
        display: flex;
        flex-direction: column;
        align-items: center;
        justify-content: center;
        gap: 16px;
      }

      .spinner {
        width: 40px;
        height: 40px;
        border: 3px solid rgba(255, 255, 255, 0.1);
        border-top: 3px solid #fff;
        border-radius: 50%;
        animation: spin 1s linear infinite;
      }

      @keyframes spin {
        0% {
          transform: rotate(0deg);
        }
        100% {
          transform: rotate(360deg);
        }
      }

      /* å“åº”å¼è®¾è®¡ */
      @media (max-width: 768px) {
        .titlebar {
          height: 50px;
          padding: 0 12px;
        }

        .container {
          top: 50px;
          bottom: 70px;
        }

        .bottom-toolbar {
          height: 70px;
          padding: 0 12px;
        }

        .toolbar-button {
          width: 36px;
          height: 36px;
          font-size: 14px;
        }

        .nav-button {
          width: 40px;
          height: 40px;
          font-size: 16px;
        }

        .nav-button.prev {
          left: 10px;
        }

        .nav-button.next {
          right: 10px;
        }

        .image-info {
          bottom: 10px;
          padding: 6px 12px;
          font-size: 12px;
        }

        .zoom-indicator {
          top: 70px;
          right: 10px;
          padding: 6px 10px;
          font-size: 11px;
        }
      }

      /* å·¥å…·æç¤º */
      .tooltip {
        position: absolute;
        background: rgba(0, 0, 0, 0.8);
        color: #fff;
        padding: 4px 8px;
        border-radius: 4px;
        font-size: 12px;
        white-space: nowrap;
        pointer-events: none;
        z-index: 1001;
        opacity: 0;
        transition: opacity 0.2s ease;
      }

      .titlebar-button:hover .tooltip {
        opacity: 1;
      }

      /* å›¾æ ‡æ ·å¼ */
      .icon {
        display: inline-block;
        width: 16px;
        height: 16px;
        text-align: center;
        line-height: 16px;
        font-size: 14px;
        font-weight: bold;
      }

      .icon-minus::before {
        content: "âˆ’";
      }
      .icon-plus::before {
        content: "+";
      }
      .icon-undo::before {
        content: "â†¶";
      }
      .icon-redo::before {
        content: "â†·";
      }
      .icon-sync::before {
        content: "â†»";
      }
      .icon-download::before {
        content: "â†“";
      }
      .icon-chevron-left::before {
        content: "â€¹";
      }
      .icon-chevron-right::before {
        content: "â€º";
      }
      .icon-hand::before {
        content: "âœ‹";
      }
      .icon-close::before {
        content: "Ã—";
      }
      .icon-maximize::before {
        content: "â–¡";
      }
      .icon-minimize::before {
        content: "âˆ’";
      }
    </style>
  </head>
  <body>
    <!-- ä¸»å®¹å™¨ -->
    <div class="container">
      <div class="image-container" id="imageContainer">
        <div class="loading" id="loading">
          <div class="spinner"></div>
          <div>åŠ è½½ä¸­...</div>
        </div>
      </div>

      <!-- å¯¼èˆªæŒ‰é’® -->
      <button class="nav-button prev" id="prevBtn" disabled>
        <span class="icon icon-chevron-left"></span>
      </button>
      <button class="nav-button next" id="nextBtn" disabled>
        <span class="icon icon-chevron-right"></span>
      </button>

      <!-- æ‹–åŠ¨æç¤º -->
      <div class="drag-hint" id="dragHint" style="display: none">
        <span class="icon icon-hand"></span> æ‹–åŠ¨å›¾ç‰‡
      </div>
    </div>

    <!-- åº•éƒ¨å·¥å…·æ  -->
    <div class="bottom-toolbar">
      <div class="toolbar-buttons">
        <!-- åŠŸèƒ½æŒ‰é’® -->
        <button
          class="toolbar-button"
          id="zoomOut"
          title="ç¼©å° (å¿«æ·é”®: - | æ»šè½®å‘ä¸‹)"
        >
          <span class="icon icon-minus"></span>
        </button>
        <button
          class="toolbar-button"
          id="zoomIn"
          title="æ”¾å¤§ (å¿«æ·é”®: + | æ»šè½®å‘ä¸Š)"
        >
          <span class="icon icon-plus"></span>
        </button>
        <button class="toolbar-button" id="rotateLeft" title="å‘å·¦æ—‹è½¬">
          <span class="icon icon-undo"></span>
        </button>
        <button class="toolbar-button" id="rotateRight" title="å‘å³æ—‹è½¬">
          <span class="icon icon-redo"></span>
        </button>
        <button class="toolbar-button" id="reset" title="é‡ç½®">
          <span class="icon icon-sync"></span>
        </button>
        <button class="toolbar-button" id="download" title="ä¿å­˜">
          <span class="icon icon-download"></span>
        </button>
      </div>
    </div>

    <script>
      // è·å–URLå‚æ•°
      const urlParams = new URLSearchParams(window.location.search);
      const imagesParam = urlParams.get("images");
      const startIndex = parseInt(urlParams.get("index") || "0");

      let images = [];
      let currentIndex = startIndex;
      let scale = 1;
      let rotation = 0;
      let isFullscreen = false;
      let currentWindow = null; // å­˜å‚¨å½“å‰çª—å£å¯¹è±¡

      // æ‹–åŠ¨ç›¸å…³å˜é‡
      let isDragging = false;
      let dragStartX = 0;
      let dragStartY = 0;
      let translateX = 0;
      let translateY = 0;

      // æ£€æµ‹ä¸»é¢˜
      function detectTheme() {
        // é¦–å…ˆå°è¯•ä» uTools å­˜å‚¨ä¸­è¯»å–ä¸»é¢˜è®¾ç½®
        let theme = null;
        if (window.utools && window.utools.dbStorage) {
          try {
            // å°è¯•è¯»å–ç”¨æˆ·è®¾ç½®ä¸­çš„ä¸»é¢˜ï¼ˆæ–°ç‰ˆæœ¬ï¼‰
            const userSettings =
              window.utools.dbStorage.getItem("fishpi_settings");
            console.log("è¯»å–åˆ°çš„ç”¨æˆ·è®¾ç½®:", userSettings);

            if (userSettings && userSettings.currentTheme) {
              theme = userSettings.currentTheme;
              console.log("ä» fishpi_settings.currentTheme è¯»å–åˆ°ä¸»é¢˜:", theme);
            }

            // å¦‚æœæ²¡æœ‰ç”¨æˆ·è®¾ç½®ï¼Œå°è¯•è¯»å–æ—§ç‰ˆæœ¬çš„ä¸»é¢˜å­˜å‚¨
            if (!theme) {
              theme = window.utools.dbStorage.getItem("theme");
              console.log("ä» theme å­˜å‚¨è¯»å–åˆ°ä¸»é¢˜:", theme);
            }
          } catch (error) {
            console.log("è¯»å–ä¸»é¢˜è®¾ç½®å¤±è´¥:", error);
          }
        }

        // å¦‚æœä»å­˜å‚¨ä¸­è¯»å–åˆ°äº†ä¸»é¢˜è®¾ç½®
        if (theme && theme !== "auto") {
          document.documentElement.setAttribute("data-theme", theme);
          console.log("åº”ç”¨å­˜å‚¨çš„ä¸»é¢˜è®¾ç½®:", theme);
          return;
        }

        // å¦‚æœæ˜¯è‡ªåŠ¨æ¨¡å¼æˆ–æ²¡æœ‰å­˜å‚¨è®¾ç½®ï¼Œæ£€æµ‹ç³»ç»Ÿä¸»é¢˜
        if (window.utools && window.utools.isDarkColors) {
          const isDark = window.utools.isDarkColors();
          const detectedTheme = isDark ? "dark" : "light";
          document.documentElement.setAttribute("data-theme", detectedTheme);
          console.log("ä½¿ç”¨ uTools API æ£€æµ‹ä¸»é¢˜:", detectedTheme);
        } else {
          // å¦‚æœæ²¡æœ‰ uTools APIï¼Œä½¿ç”¨ç³»ç»Ÿä¸»é¢˜æ£€æµ‹
          const prefersDark = window.matchMedia(
            "(prefers-color-scheme: dark)"
          ).matches;
          const detectedTheme = prefersDark ? "dark" : "light";
          document.documentElement.setAttribute("data-theme", detectedTheme);
          console.log("ä½¿ç”¨ç³»ç»Ÿä¸»é¢˜æ£€æµ‹:", detectedTheme);
        }
      }

      // åˆå§‹åŒ–
      document.addEventListener("DOMContentLoaded", function () {
        console.log("DOMåŠ è½½å®Œæˆï¼Œå¼€å§‹åˆå§‹åŒ–...");
        console.log("uTools API æ£€æµ‹:", {
          utools: !!window.utools,
          utoolsHideMainWindow: !!(
            window.utools && window.utools.hideMainWindow
          ),
          utoolsMaximize: !!(window.utools && window.utools.maximize),
          utoolsOutPlugin: !!(window.utools && window.utools.outPlugin),
        });

        detectTheme();

        try {
          console.log("åŸå§‹å›¾ç‰‡å‚æ•°:", imagesParam);
          images = JSON.parse(decodeURIComponent(imagesParam));
          console.log("è§£æåçš„å›¾ç‰‡æ•°ç»„:", images);
          console.log("å›¾ç‰‡æ•°é‡:", images.length);
          console.log("èµ·å§‹ç´¢å¼•:", startIndex);

          if (images.length === 0) {
            showError("æ²¡æœ‰æ‰¾åˆ°å›¾ç‰‡");
            return;
          }

          loadImage(currentIndex);
          updateNavigation();

          // ç›‘å¬æ¥è‡ªçˆ¶çª—å£çš„æ¶ˆæ¯
          if (window.utools) {
            try {
              // å°è¯•æ¥æ”¶çª—å£ä¿¡æ¯
              window.utools.on("window-info", (data) => {
                console.log("æ¥æ”¶åˆ°çª—å£ä¿¡æ¯:", data);
                currentWindow = data;
              });
            } catch (error) {
              console.log("æ— æ³•è®¾ç½®æ¶ˆæ¯ç›‘å¬å™¨:", error);
            }
          }

          // æ»šè½®ç¼©æ”¾åŠŸèƒ½
          setupWheelZoom();

          // å®šæœŸæ£€æŸ¥ä¸»é¢˜è®¾ç½®å˜åŒ–
          setupThemeWatcher();

          // è®¾ç½®æ‹–åŠ¨åŠŸèƒ½
          setupDragHandlers();

          // ç¡®ä¿é”®ç›˜äº‹ä»¶ç›‘å¬å™¨æ­£å¸¸å·¥ä½œ
          console.log("è®¾ç½®é”®ç›˜äº‹ä»¶ç›‘å¬å™¨");
        } catch (error) {
          console.error("è§£æå›¾ç‰‡å‚æ•°å¤±è´¥:", error);
          showError("åŠ è½½å›¾ç‰‡å¤±è´¥");
        }
      });

      // åŠ è½½å›¾ç‰‡
      function loadImage(index) {
        console.log("loadImage è¢«è°ƒç”¨ï¼Œç´¢å¼•:", index);
        if (index < 0 || index >= images.length) {
          console.error("å›¾ç‰‡ç´¢å¼•è¶…å‡ºèŒƒå›´:", index);
          return;
        }

        const container = document.getElementById("imageContainer");
        const loading = document.getElementById("loading");

        console.log("å®¹å™¨å…ƒç´ :", container);
        console.log("åŠ è½½å…ƒç´ :", loading);

        // æ˜¾ç¤ºåŠ è½½çŠ¶æ€
        if (loading) {
          loading.style.display = "flex";
        }
        if (container) {
          container.innerHTML = "";
          if (loading) {
            container.appendChild(loading);
          }
        }

        const img = new Image();
        img.onload = function () {
          console.log("å›¾ç‰‡åŠ è½½æˆåŠŸ:", images[index].src);
          if (loading) {
            loading.style.display = "none";
          }
          if (container) {
            container.innerHTML = "";
            container.appendChild(img);
          }

          // è®¾ç½®åˆé€‚çš„åˆå§‹ç¼©æ”¾æ¯”ä¾‹ï¼Œè®©å›¾ç‰‡ä¸ä¼šé“ºæ»¡çª—å£
          scale = 1;
          rotation = 0;
          translateX = 0;
          translateY = 0;
          updateTransform();

          // æ ¹æ®å›¾ç‰‡å°ºå¯¸è°ƒæ•´çª—å£å¤§å°
          adjustWindowSize(img);
        };

        img.onerror = function () {
          console.error("å›¾ç‰‡åŠ è½½å¤±è´¥:", images[index].src);
          if (loading) {
            loading.style.display = "none";
          }
          showError("å›¾ç‰‡åŠ è½½å¤±è´¥");
        };

        img.src = images[index].src;
        currentIndex = index;
        console.log("å½“å‰ç´¢å¼•å·²æ›´æ–°ä¸º:", currentIndex);
      }

      // æ›´æ–°å˜æ¢
      function updateTransform() {
        const container = document.getElementById("imageContainer");
        container.style.transform = `translate(${translateX}px, ${translateY}px) scale(${scale}) rotate(${rotation}deg)`;
      }

      // æ›´æ–°å¯¼èˆªçŠ¶æ€
      function updateNavigation() {
        const prevBtn = document.getElementById("prevBtn");
        const nextBtn = document.getElementById("nextBtn");

        prevBtn.disabled = currentIndex === 0;
        nextBtn.disabled = currentIndex === images.length - 1;
      }

      // æ˜¾ç¤ºé”™è¯¯
      function showError(message) {
        const container = document.getElementById("imageContainer");
        container.innerHTML = `
          <div style="text-align: center; color: var(--text-color);">
            <div style="font-size: 48px; margin-bottom: 16px;">ğŸ˜</div>
            <div style="font-size: 16px;">${message}</div>
          </div>
        `;
      }

      // äº‹ä»¶ç›‘å¬å™¨
      document.getElementById("prevBtn").addEventListener("click", () => {
        console.log("ä¸Šä¸€å¼ æŒ‰é’®è¢«ç‚¹å‡»");
        if (currentIndex > 0) {
          loadImage(currentIndex - 1);
          updateNavigation();
        }
      });

      document.getElementById("nextBtn").addEventListener("click", () => {
        console.log("ä¸‹ä¸€å¼ æŒ‰é’®è¢«ç‚¹å‡»");
        if (currentIndex < images.length - 1) {
          loadImage(currentIndex + 1);
          updateNavigation();
        }
      });

      // ç¼©æ”¾åŠŸèƒ½
      document.getElementById("zoomIn").addEventListener("click", () => {
        scale = Math.min(scale * 1.2, 5);
        updateTransform();
      });

      document.getElementById("zoomOut").addEventListener("click", () => {
        scale = Math.max(scale / 1.2, 0.1);
        updateTransform();
      });

      // æ—‹è½¬åŠŸèƒ½
      document.getElementById("rotateLeft").addEventListener("click", () => {
        rotation -= 90;
        updateTransform();
      });

      document.getElementById("rotateRight").addEventListener("click", () => {
        rotation += 90;
        updateTransform();
      });

      // é‡ç½®åŠŸèƒ½
      document.getElementById("reset").addEventListener("click", () => {
        scale = 1;
        rotation = 0;
        translateX = 0;
        translateY = 0;
        updateTransform();
      });

      // é‡ç½®ä½ç½®åŠŸèƒ½
      document.getElementById("resetPosition").addEventListener("click", () => {
        console.log("é‡ç½®ä½ç½®æŒ‰é’®è¢«ç‚¹å‡»");
        translateX = 0;
        translateY = 0;
        updateTransform();
      });

      // ä¸‹è½½åŠŸèƒ½
      document.getElementById("download").addEventListener("click", () => {
        if (images[currentIndex]) {
          const link = document.createElement("a");
          link.href = images[currentIndex].src;
          link.download = `image_${currentIndex + 1}.jpg`;
          link.click();
        }
      });

      // å…¨å±åŠŸèƒ½
      document.getElementById("fullscreen").addEventListener("click", () => {
        if (!document.fullscreenElement) {
          document.documentElement.requestFullscreen();
          isFullscreen = true;
        } else {
          document.exitFullscreen();
          isFullscreen = false;
        }
      });

      document.getElementById("close").addEventListener("click", () => {
        console.log("å…³é—­æŒ‰é’®è¢«ç‚¹å‡»");
        console.log("uTools API å¯ç”¨æ€§:", !!window.utools);

        if (window.utools) {
          try {
            console.log("å°è¯•ä½¿ç”¨ uTools outPlugin å…³é—­çª—å£");
            window.utools.outPlugin();
          } catch (e) {
            console.error("uTools outPlugin å¤±è´¥:", e);
            window.close();
          }
        } else {
          console.log("uTools API ä¸å¯ç”¨ï¼Œä½¿ç”¨ window.close");
          window.close();
        }
      });
      // é”®ç›˜å¿«æ·é”®
      document.addEventListener("keydown", (e) => {
        console.log("é”®ç›˜äº‹ä»¶:", e.key, "keyCode:", e.keyCode);
        switch (e.key) {
          case "ArrowLeft":
            if (currentIndex > 0) {
              loadImage(currentIndex - 1);
              updateNavigation();
            }
            break;
          case "ArrowRight":
            if (currentIndex < images.length - 1) {
              loadImage(currentIndex + 1);
              updateNavigation();
            }
            break;
          case "Escape":
            if (document.fullscreenElement) {
              document.exitFullscreen();
              isFullscreen = false;
            } else {
              document.getElementById("close").click();
            }
            break;
          case "+":
          case "=":
            e.preventDefault();
            document.getElementById("zoomIn").click();
            break;
          case "-":
            e.preventDefault();
            document.getElementById("zoomOut").click();
            break;
          case "0":
            document.getElementById("reset").click();
            break;
          case " ":
            e.preventDefault();
            console.log("ç©ºæ ¼é”®è¢«æŒ‰ä¸‹ï¼Œé‡ç½®æ‹–åŠ¨ä½ç½®");
            // ç©ºæ ¼é”®é‡ç½®æ‹–åŠ¨ä½ç½®
            translateX = 0;
            translateY = 0;
            updateTransform();
            console.log("æ‹–åŠ¨ä½ç½®å·²é‡ç½®");
            break;
        }
      });

      // ä¸“é—¨å¤„ç†ç©ºæ ¼é”®ï¼Œç¡®ä¿èƒ½å¤Ÿæ­£å¸¸å·¥ä½œ
      document.addEventListener(
        "keydown",
        (e) => {
          if (e.code === "Space" || e.key === " ") {
            e.preventDefault();
            e.stopPropagation();
            console.log("ç©ºæ ¼é”®è¢«æ•è·ï¼Œé‡ç½®æ‹–åŠ¨ä½ç½®");
            translateX = 0;
            translateY = 0;
            updateTransform();
            console.log("æ‹–åŠ¨ä½ç½®å·²é‡ç½®");
          }
        },
        true
      );

      // åŒå‡»é‡ç½®
      document.addEventListener("dblclick", () => {
        document.getElementById("reset").click();
      });

      // æ»šè½®ç¼©æ”¾åŠŸèƒ½
      function setupWheelZoom() {
        document.addEventListener(
          "wheel",
          (e) => {
            e.preventDefault(); // é˜»æ­¢é»˜è®¤æ»šåŠ¨è¡Œä¸º
            e.stopPropagation(); // é˜»æ­¢äº‹ä»¶å†’æ³¡

            // è·å–æ»šè½®æ–¹å‘
            const delta = e.deltaY;

            // æ ¹æ®æ»šè½®æ–¹å‘è°ƒæ•´ç¼©æ”¾
            if (delta < 0) {
              // å‘ä¸Šæ»šåŠ¨ï¼Œæ”¾å¤§
              scale = Math.min(scale * 1.1, 5);
            } else {
              // å‘ä¸‹æ»šåŠ¨ï¼Œç¼©å°
              scale = Math.max(scale / 1.1, 0.1);
            }

            updateTransform();
          },
          { passive: false, capture: true }
        );
      }

      // å®šæœŸæ£€æŸ¥ä¸»é¢˜è®¾ç½®å˜åŒ–
      function setupThemeWatcher() {
        let lastTheme = null;

        // è·å–å½“å‰ä¸»é¢˜
        function getCurrentTheme() {
          if (window.utools && window.utools.dbStorage) {
            try {
              // é¦–å…ˆå°è¯•è¯»å–ç”¨æˆ·ç‰¹å®šçš„è®¾ç½®
              const userSettings =
                window.utools.dbStorage.getItem("fishpi_settings");
              if (userSettings && userSettings.currentTheme) {
                return userSettings.currentTheme;
              }

              // å¦‚æœæ²¡æœ‰ç”¨æˆ·è®¾ç½®ï¼Œå°è¯•è¯»å–å…¨å±€ä¸»é¢˜è®¾ç½®
              return window.utools.dbStorage.getItem("theme");
            } catch (error) {
              console.log("è¯»å–ä¸»é¢˜è®¾ç½®å¤±è´¥:", error);
            }
          }
          return null;
        }

        // æ£€æŸ¥ä¸»é¢˜æ˜¯å¦å‘ç”Ÿå˜åŒ–
        function checkThemeChange() {
          const currentTheme = getCurrentTheme();
          if (currentTheme !== lastTheme) {
            console.log("æ£€æµ‹åˆ°ä¸»é¢˜å˜åŒ–:", lastTheme, "->", currentTheme);
            lastTheme = currentTheme;
            detectTheme();
          }
        }

        // åˆå§‹åŒ–å½“å‰ä¸»é¢˜
        lastTheme = getCurrentTheme();
        console.log("åˆå§‹åŒ–ä¸»é¢˜ç›‘å¬å™¨ï¼Œå½“å‰ä¸»é¢˜:", lastTheme);

        // å®šæœŸæ£€æŸ¥ä¸»é¢˜å˜åŒ–ï¼ˆæ¯2ç§’æ£€æŸ¥ä¸€æ¬¡ï¼‰
        setInterval(checkThemeChange, 2000);

        // ç›‘å¬ç³»ç»Ÿä¸»é¢˜å˜åŒ–
        if (window.matchMedia) {
          window
            .matchMedia("(prefers-color-scheme: dark)")
            .addEventListener("change", () => {
              // åªæœ‰åœ¨è‡ªåŠ¨æ¨¡å¼ä¸‹æ‰å“åº”ç³»ç»Ÿä¸»é¢˜å˜åŒ–
              const storedTheme = getCurrentTheme();
              if (!storedTheme || storedTheme === "auto") {
                console.log("ç³»ç»Ÿä¸»é¢˜å‘ç”Ÿå˜åŒ–ï¼Œé‡æ–°æ£€æµ‹");
                detectTheme();
              }
            });
        }
      }

      // è°ƒè¯•ä¿¡æ¯
      console.log("å›¾ç‰‡é¢„è§ˆé¡µé¢å·²åŠ è½½");
      console.log("å›¾ç‰‡æ•°é‡:", images.length);
      console.log("å½“å‰ç´¢å¼•:", currentIndex);

      // æ ¹æ®å›¾ç‰‡å°ºå¯¸è°ƒæ•´çª—å£å¤§å°
      function adjustWindowSize(img) {
        console.log(
          "è°ƒæ•´çª—å£å¤§å°ï¼Œå›¾ç‰‡å°ºå¯¸:",
          img.naturalWidth,
          "x",
          img.naturalHeight
        );

        // è·å–å±å¹•å°ºå¯¸
        const screenWidth = window.screen.width;
        const screenHeight = window.screen.height;

        // è®¾ç½®æœ€å¤§çª—å£å°ºå¯¸ï¼ˆå±å¹•çš„80%ï¼‰
        const maxWidth = screenWidth * 0.6;
        const maxHeight = screenHeight * 0.6;

        // è®¾ç½®æœ€å°çª—å£å°ºå¯¸
        const minWidth = 800;
        const minHeight = 600;

        // æ ‡é¢˜æ é«˜åº¦
        const titleBarHeight = 40;
        // åº•éƒ¨å·¥å…·æ é«˜åº¦
        const bottomToolbarHeight = 60;

        // è®¡ç®—å›¾ç‰‡æ˜¾ç¤ºå°ºå¯¸
        let displayWidth = img.naturalWidth;
        let displayHeight = img.naturalHeight;

        console.log("åˆå§‹æ˜¾ç¤ºå°ºå¯¸:", displayWidth, "x", displayHeight);

        // å¦‚æœå›¾ç‰‡å¤ªå¤§ï¼ŒæŒ‰æ¯”ä¾‹ç¼©å°åˆ°æœ€å¤§å°ºå¯¸å†…
        if (displayWidth > maxWidth || displayHeight > maxHeight) {
          const ratio = Math.min(
            maxWidth / displayWidth,
            maxHeight / displayHeight
          );
          displayWidth = Math.floor(displayWidth * ratio);
          displayHeight = Math.floor(displayHeight * ratio);
          console.log("å›¾ç‰‡è¿‡å¤§ï¼Œç¼©æ”¾æ¯”ä¾‹:", ratio);
          console.log("ç¼©æ”¾åå°ºå¯¸:", displayWidth, "x", displayHeight);
        }

        // ç¡®ä¿ä¸å°äºæœ€å°å°ºå¯¸
        displayWidth = Math.max(displayWidth, minWidth);
        displayHeight = Math.max(displayHeight, minHeight);

        // è®¡ç®—çª—å£æ€»é«˜åº¦ï¼ˆå›¾ç‰‡é«˜åº¦ + æ ‡é¢˜æ é«˜åº¦ + åº•éƒ¨å·¥å…·æ é«˜åº¦ï¼‰
        const windowHeight =
          displayHeight + titleBarHeight + bottomToolbarHeight;

        console.log("æœ€ç»ˆçª—å£å°ºå¯¸:", displayWidth, "x", windowHeight);

        // åœ¨ uTools ç¯å¢ƒä¸­è°ƒæ•´çª—å£å¤§å°
        if (window.utools) {
          try {
            // å°è¯•ä½¿ç”¨ window.resizeTo (å¦‚æœå¯ç”¨)
            if (window.resizeTo) {
              window.resizeTo(displayWidth, windowHeight);
              console.log("ä½¿ç”¨ window.resizeTo è°ƒæ•´çª—å£å¤§å°");
            } else {
              console.log("window.resizeTo ä¸å¯ç”¨");
            }

            // å¦‚æœæœ‰çª—å£å¯¹è±¡ï¼Œå°è¯•ä½¿ç”¨å…¶æ–¹æ³•
            if (currentWindow && currentWindow.windowId) {
              console.log("å°è¯•ä½¿ç”¨çª—å£å¯¹è±¡è°ƒæ•´å¤§å°");
              // è¿™é‡Œéœ€è¦çˆ¶çª—å£ä¼ é€’çª—å£å¯¹è±¡ï¼Œæˆ–è€…é€šè¿‡å…¶ä»–æ–¹å¼è·å–
            }
          } catch (error) {
            console.error("è°ƒæ•´çª—å£å¤§å°å¤±è´¥:", error);
          }
        }
      }

      // è®¾ç½®æ‹–åŠ¨åŠŸèƒ½
      function setupDragHandlers() {
        const container = document.getElementById("imageContainer");
        const dragHint = document.getElementById("dragHint");

        // æ˜¾ç¤ºæ‹–åŠ¨æç¤º
        function showDragHint() {
          dragHint.style.display = "block";
          setTimeout(() => {
            dragHint.classList.add("show");
          }, 100);
        }

        // éšè—æ‹–åŠ¨æç¤º
        function hideDragHint() {
          dragHint.classList.remove("show");
          setTimeout(() => {
            dragHint.style.display = "none";
          }, 300);
        }

        // é¡µé¢åŠ è½½åæ˜¾ç¤ºæç¤º
        setTimeout(() => {
          showDragHint();
          setTimeout(hideDragHint, 3000);
        }, 1000);

        container.addEventListener("mousedown", (e) => {
          // å…è®¸ç›´æ¥æ‹–åŠ¨ï¼Œä½†æ’é™¤æŒ‰é’®ç‚¹å‡»
          if (
            e.target.tagName !== "BUTTON" &&
            e.target.closest(".titlebar") === null
          ) {
            isDragging = true;
            dragStartX = e.clientX;
            dragStartY = e.clientY;
            container.style.cursor = "grabbing";
            container.style.transition = "none"; // æ‹–åŠ¨æ—¶ç¦ç”¨è¿‡æ¸¡åŠ¨ç”»
            hideDragHint();
            e.preventDefault();
          }
        });

        document.addEventListener("mousemove", (e) => {
          if (isDragging) {
            const deltaX = e.clientX - dragStartX;
            const deltaY = e.clientY - dragStartY;
            translateX += deltaX;
            translateY += deltaY;

            // æ·»åŠ è¾¹ç•Œé™åˆ¶ï¼Œé˜²æ­¢å›¾ç‰‡è¢«æ‹–å‡ºè§†é‡å¤ªè¿œ
            const maxTranslate = 500; // æœ€å¤§æ‹–åŠ¨è·ç¦»
            translateX = Math.max(
              -maxTranslate,
              Math.min(maxTranslate, translateX)
            );
            translateY = Math.max(
              -maxTranslate,
              Math.min(maxTranslate, translateY)
            );

            dragStartX = e.clientX;
            dragStartY = e.clientY;
            updateTransform();
            e.preventDefault();
          }
        });

        document.addEventListener("mouseup", () => {
          if (isDragging) {
            isDragging = false;
            container.style.cursor = "grab";
            container.style.transition = "transform 0.3s ease"; // æ¢å¤è¿‡æ¸¡åŠ¨ç”»

            // å¦‚æœå›¾ç‰‡è¢«æ‹–å‡ºè¾¹ç•Œï¼Œè‡ªåŠ¨å›åˆ°è¾¹ç•Œå†…
            const maxTranslate = 500;
            if (
              Math.abs(translateX) > maxTranslate ||
              Math.abs(translateY) > maxTranslate
            ) {
              translateX = Math.max(
                -maxTranslate,
                Math.min(maxTranslate, translateX)
              );
              translateY = Math.max(
                -maxTranslate,
                Math.min(maxTranslate, translateY)
              );
              updateTransform();
            }
          }
        });

        // é¼ æ ‡æ‚¬åœæ—¶æ˜¾ç¤ºæ‹–åŠ¨æç¤º
        container.addEventListener("mouseenter", () => {
          if (!isDragging) {
            container.style.cursor = "grab";
          }
        });

        container.addEventListener("mouseleave", () => {
          if (!isDragging) {
            container.style.cursor = "default";
          }
        });

        // é˜²æ­¢æ‹–åŠ¨æ—¶é€‰ä¸­æ–‡æœ¬
        container.addEventListener("selectstart", (e) => {
          if (isDragging) {
            e.preventDefault();
          }
        });
      }
    </script>
  </body>
</html>
